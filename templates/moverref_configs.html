{% extends 'home.html' %}
{% block content %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    var myChart;

// Fetch data from the Flask route
fetch("/get_moverref_data")
.then(response => response.json())
.then(data => {
    // Extract moverrefs and their counts from the returned data
    const moverrefs = Object.keys(data);
    const counts = Object.values(data);

    // Create a bar chart
    var ctx = document.getElementById('moverrefChart').getContext('2d');
    myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: moverrefs,
            datasets: [{
                label: 'Number of Leads',
                data: counts,
                backgroundColor: 'rgba(65, 105, 225, 0.2)',  // Change to your preferred color
                borderColor: 'rgba(65, 105, 225, 1)',  // Change to your preferred color
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    document.getElementById("apply-date-filter").addEventListener("click", function() {
            let startDate = document.getElementById("start-date").value;
            let endDate = document.getElementById("end-date").value;
            updateChart(startDate, endDate);
        });

        document.getElementById("show-today").addEventListener("click", function() {
            let today = new Date().toISOString().split("T")[0];
            updateChart(today, today);
        });

        document.getElementById("show-all-time").addEventListener("click", function() {
            updateChart(null, null);
        });

    })
    .catch(error => console.error("There was an error loading the data", error));

    function updateChart(startDate, endDate) {
        let url = "/get_moverref_data";
        if(startDate && endDate) {
            url += `?start_date=${startDate}&end_date=${endDate}`;
        }

        fetch(url)
        .then(response => response.json())
        .then(data => {
            // Assuming you have a 'myChart' variable representing your chart:
            myChart.data.labels = Object.keys(data);
            myChart.data.datasets[0].data = Object.values(data);
            myChart.update();
        });
    }

});
</script>

<div class="head">
<h1 style="color:white">Lead Distribution</h1>
</div>

<!-- Add New Configuration Modal -->
<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModalLabel">Add New Department/Lead Configuration</h5>
            </div>
            <form action="{{ url_for('moverref.add_moverref_config') }}" method="post">
                <div class="modal-body">
                    <label for="name"> Department Name (email):</label>
                    <input type="text" name="name" required>
                    <br>
                    <label for="repeat_count">Lead Assignment Count:</label>
                    <input type="number" name="repeat_count" required>
                </div>
                <div class="modal-footer">
                    <input type="submit" class="filter" value="Add">
                </div>
            </form>
        </div>
    </div>
</div>

<!-- List of all configurations -->
<div class="table-responsive">
<table class="table table-bordered table-hover">
    <thead class="thead-light">
        <tr>
            <th class="text-center"  data-toggle="tooltip" title="Department 'TA' = customerservice@safeshipmoving.com. Department 'TB' = rachel.s@safeshipmoving.com." style="text-shadow:black 2px 2px; color:white; font-weight: bolder;background-color: #434343; cursor: pointer;">Department</th>
            <th class="text-center" data-toggle="tooltip" title="The number of Lead Assignments determines the distribution ratio. '1' means one lead is assigned before moving to the next department. '2' means two leads are assigned first, and so on." style="text-shadow:black 2px 2px; color:white; font-weight: bolder;background-color: #434343; cursor: pointer;">Number of Leads </th>
            <th class="text-center"  style="text-shadow:black 2px 2px; color:white; font-weight: bolder;background-color: #434343; cursor: pointer;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for config in configs %}
        <tr>
            <td class="text-center">
                <span class="data-name">{{ config.name }}</span>
            </td>
            <td class="text-center">
                <span class="data-repeat_count">{{ config.repeat_count }}</span>
            </td>
            <td class="text-center">
                <button class="filter" title="Settings" onclick="showEditForm(this, {{ config.id }})"><i class="fa-solid fa-gear" title="Settings" style="cursor:pointer"></i></button>
                <form action="{{ url_for('moverref.delete_moverref_config', config_id=config.id) }}" method="post" style="display:inline;">
                    <button type="submit" class="deleteBtn" onclick="return confirm('Are you sure you want to delete?')"><i class="fa-solid fa-trash-can" title="Delete" style="cursor:pointer"></i></button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<!-- Form to add a new configuration -->
<button style="margin-left: 10px;"class="filter" onclick="$('#addModal').modal('show')"><i class="fa-solid fa-plus"></i> Add New Department</button>
</div>

<div style="background-color: #434343; padding-top: 10px; margin-top:50px">
    <h2 style="text-align: center; color: white; text-shadow: black 2px 2px 2px;">Department Metrics</h2>
    <div style="margin-bottom: 20px; display: flex;">
        <label for="start-date">Start Date: </label>
        <input type="date" id="start-date">
        
        <label for="end-date" style="margin-left: 20px;">End Date: </label>
        <input type="date" id="end-date">
        
        <button id="apply-date-filter" style="margin-left: 20px;">Apply Date Filter</button>
        <button id="show-today" style="margin-left: 20px;">Today</button>
        <button id="show-all-time" style="margin-left: 20px;">All Time</button>
    </div>
    <!-- Chart for leads by department -->
    <canvas id="moverrefChart" width="200" height="80" style="background-color: white; padding-bottom: 20px;"></canvas>
</div>

<div style="padding-bottom: 20px; padding-top: 10px;">
    <a style='padding:4px; text-decoration: none; margin-bottom: 20px; margin-left: 10px;' class="filter" href="https://safe-leads.herokuapp.com/show_moverref_configs">Shared Lead Metrics</a>
</div>
<!-- Edit Configuration Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Edit Configuration</h5>
      </div>
      <form id="modalForm" method="post">
        <div class="modal-body">
          <label for="modalName">Name:</label>
          <input type="text" id="modalName" name="name">
          <br>
          <label for="modalRepeatCount">Repeat Count:</label>
          <input type="number" id="modalRepeatCount" name="repeat_count">
        </div>
        <div class="modal-footer">
          <input type="submit" class="filter" value="Save">
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function showEditForm(buttonElement, configId) {
    const trElement = buttonElement.closest('tr');
    
    const name = trElement.querySelector('.data-name').textContent;
 
    const repeatCount = trElement.querySelector('.data-repeat_count').textContent;

    document.getElementById('modalName').value = name;

    document.getElementById('modalRepeatCount').value = repeatCount;

    // Set the form's action to the correct endpoint
    document.getElementById('modalForm').action = `/edit_moverref_config/${configId}`;

    $('#editModal').modal('show');
}
</script>

{% endblock %}